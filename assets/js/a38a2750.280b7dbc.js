"use strict";(self.webpackChunknotebook=self.webpackChunknotebook||[]).push([[4856],{9277:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>i,toc:()=>c});var t=r(4848),s=r(8453);const a={sidebar_label:"1. SSM\u6e90\u7801\u5206\u6790"},o="SSM\uff08Spring + SpringMVC + MyBatis\uff09",i={id:"bjpowernode/\u4e3b\u6d41\u6846\u67b6/SSM\u6e90\u7801\u5206\u6790",title:"SSM\uff08Spring + SpringMVC + MyBatis\uff09",description:"1 MyBatis\u6e90\u7801\u6784\u5efa",source:"@site/docs/bjpowernode/04-\u4e3b\u6d41\u6846\u67b6/01-SSM\u6e90\u7801\u5206\u6790.md",sourceDirName:"bjpowernode/04-\u4e3b\u6d41\u6846\u67b6",slug:"/bjpowernode/\u4e3b\u6d41\u6846\u67b6/SSM\u6e90\u7801\u5206\u6790",permalink:"/ZHENGnotes/bjpowernode/\u4e3b\u6d41\u6846\u67b6/SSM\u6e90\u7801\u5206\u6790",draft:!1,unlisted:!1,tags:[],version:"current",sidebarPosition:1,frontMatter:{sidebar_label:"1. SSM\u6e90\u7801\u5206\u6790"},sidebar:"defaultSidebar",previous:{title:"0. \u5c0f\u7ed3",permalink:"/ZHENGnotes/bjpowernode/\u4e3b\u6d41\u6846\u67b6/summary"},next:{title:"5. \u6846\u67b6\u9879\u76ee\uff08\u7565\uff09",permalink:"/ZHENGnotes/bjpowernode/\u6846\u67b6\u9879\u76ee\uff08\u7565\uff09"}},l={},c=[{value:"1 MyBatis\u6e90\u7801\u6784\u5efa",id:"1-mybatis\u6e90\u7801\u6784\u5efa",level:2},{value:"2 MyBatis\u52a8\u6001\u4ee3\u7406",id:"2-mybatis\u52a8\u6001\u4ee3\u7406",level:2},{value:"3 MyBatis\u6838\u5fc3SQL\u6620\u5c04",id:"3-mybatis\u6838\u5fc3sql\u6620\u5c04",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",li:"li",ol:"ol",p:"p",pre:"pre",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.h1,{id:"ssmspring--springmvc--mybatis",children:"SSM\uff08Spring + SpringMVC + MyBatis\uff09"}),"\n",(0,t.jsx)(n.h2,{id:"1-mybatis\u6e90\u7801\u6784\u5efa",children:"1 MyBatis\u6e90\u7801\u6784\u5efa"}),"\n",(0,t.jsx)(n.h2,{id:"2-mybatis\u52a8\u6001\u4ee3\u7406",children:"2 MyBatis\u52a8\u6001\u4ee3\u7406"}),"\n",(0,t.jsx)(n.h2,{id:"3-mybatis\u6838\u5fc3sql\u6620\u5c04",children:"3 MyBatis\u6838\u5fc3SQL\u6620\u5c04"}),"\n",(0,t.jsxs)(n.ol,{start:"0",children:["\n",(0,t.jsxs)(n.li,{children:["\u4ee5",(0,t.jsx)(n.code,{children:"userMapper.selectById(1)"}),"\u6267\u884c\u4e3a\u4f8b\uff0c\u89e3\u6790\u6e90\u7801"]}),"\n",(0,t.jsxs)(n.li,{children:["\u8fdb\u5165",(0,t.jsx)(n.code,{children:"MapperProxy.invoke()"}),"\uff1astep 1\u5305\u542b\u5e8f\u53f72-5\uff0cstep 1\u5305\u542b\u5e8f\u53f76","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// v3.5.14\r\nreturn Object.class.equals(method.getDeclaringClass()) ? method.invoke(this, args) : this.cachedInvoker(method).invoke(proxy, method, args, this.sqlSession);\r\n// this.cachedInvoker(method)\u8fd4\u56de\u503c\uff0c\u65b0\u5efa\u4e00\u4e2aMapperMethod\u5bf9\u8c61\r\nreturn new MapperProxy.PlainMethodInvoker(new MapperMethod(this.mapperInterface, method, this.sqlSession.getConfiguration()));\r\n// MapperMethodInvoker.invoke(proxy, method, args, this.sqlSession)\u8fd4\u56de\u503c\r\nreturn this.mapperMethod.execute(sqlSession, args);\r\n\r\n// v3.5.4\r\n// step 1. \u83b7\u53d6\u4e00\u4e2aMapperMethod\u5bf9\u8c61\uff08\u5e8f\u53f72-5\uff09\r\nfinal MapperMethod mapperMethod = cachedMapperMethod(method);\r\n// step 2. \u8c03\u7528MapperMethod\u5bf9\u8c61\u7684execute\u65b9\u6cd5\uff08\u5e8f\u53f76\uff09\r\nreturn mapperMethod.execute(sqlSession, args);\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u67e5\u770b\u65b9\u6cd5\u7f13\u5b58\u7684Map\u4e2d\u662f\u5426\u5b58\u5728\u8fd9\u4e2a\u65b9\u6cd5\u7684MapperMethod\u5bf9\u8c61",(0,t.jsx)(n.code,{children:"computeIfAbsent()"}),"\uff1a\u5982\u679c\u5b58\u5728\u5c31\u76f4\u63a5\u4ece\u7f13\u5b58\u4e2d\u62ff\uff0c\u5982\u679c\u6ca1\u6709\u5c31\u5c06\u8be5\u65b9\u6cd5\u653e\u5165\u7f13\u5b58\u4e2d","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// v3.5.14\r\nreturn (MapperProxy.MapperMethodInvoker)MapUtil.computeIfAbsent(this.methodCache, method, (m) -> {\r\n    if (!m.isDefault()) {\r\n        return new MapperProxy.PlainMethodInvoker(new MapperMethod(this.mapperInterface, method, this.sqlSession.getConfiguration()));\r\n    } else {\r\n        try {\r\n            return privateLookupInMethod == null ? new MapperProxy.DefaultMethodInvoker(this.getMethodHandleJava8(method)) : new MapperProxy.DefaultMethodInvoker(this.getMethodHandleJava9(method));\r\n        } catch (InstantiationException | InvocationTargetException | NoSuchMethodException | IllegalAccessException var4) {\r\n            throw new RuntimeException(var4);\r\n        }\r\n    }\r\n});\r\n\r\n// v3.5.4\r\nreturn methodCache.computeIfAbsent(method, k -> new MapperMethod(mapperInterface, method, sqlSession.getConfiguration()));\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6784\u5efaMapperMethod\u5bf9\u8c61\uff1a\u5b9a\u4e49SQL\u547d\u4ee4\uff08SqlCommand\u5bf9\u8c61\uff09\u548c\u65b9\u6cd5\u7b7e\u540d\uff08MethodSignature\u5bf9\u8c61\uff09","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// v3.5.14 & v3.5.4\r\nthis.command = new MapperMethod.SqlCommand(config, mapperInterface, method);\r\nthis.method = new MapperMethod.MethodSignature(config, mapperInterface, method);\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6784\u5efaSqlCommand\u5bf9\u8c61\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// v3.5.14 & v3.5.4\r\n// new MapperMethod.SqlCommand(config, mapperInterface, method)\u65b9\u6cd5\u4f53\r\nString methodName = method.getName();\r\nClass<?> declaringClass = method.getDeclaringClass();\r\n// \u89e3\u6790\u6620\u5c04\u8bed\u53e5\uff0c\u8f6c\u6362\u6210SQL\u8bed\u53e5\u5bf9\u8c61\r\nMappedStatement ms = this.resolveMappedStatement(mapperInterface, methodName, declaringClass, configuration);\r\nif (ms == null) {\r\n    // ...\r\n} else {\r\n    this.name = ms.getId();\r\n    // SQL\u547d\u4ee4\u7c7b\u578b\uff1a\u589e\u3001\u5220\u3001\u6539\u3001\u67e5\r\n    this.type = ms.getSqlCommandType();\r\n    if (this.type == SqlCommandType.UNKNOWN) {\r\n        throw new BindingException("Unknown execution method for: " + this.name);\r\n    }\r\n}\r\n\r\n// this.resolveMappedStatement(mapperInterface, methodName, declaringClass, configuration)\u65b9\u6cd5\u4f53\r\nString statementId = mapperInterface.getName() + "." + methodName;\r\n// \u67e5\u770bXML\u914d\u7f6e\u6587\u4ef6\u4e2d\u662f\u5426\u5b58\u5728statementId\u7684\u8bed\u53e5\r\nif (configuration.hasStatement(statementId)) {\r\n    return configuration.getMappedStatement(statementId);\r\n} // ...\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u6784\u5efaMethodSignature\u5bf9\u8c61\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// v3.5.14 & v3.5.4\r\nType resolvedReturnType = TypeParameterResolver.resolveReturnType(method, mapperInterface);\r\nif (resolvedReturnType instanceof Class) {\r\n    this.returnType = (Class)resolvedReturnType;\r\n} else if (resolvedReturnType instanceof ParameterizedType) {\r\n    this.returnType = (Class)((ParameterizedType)resolvedReturnType).getRawType();\r\n} else {\r\n    this.returnType = method.getReturnType();\r\n}\r\nthis.returnsVoid = Void.TYPE.equals(this.returnType);\r\nthis.returnsMany = configuration.getObjectFactory().isCollection(this.returnType) || this.returnType.isArray();\r\nthis.returnsCursor = Cursor.class.equals(this.returnType);\r\nthis.returnsOptional = Optional.class.equals(this.returnType);\r\nthis.mapKey = this.getMapKey(method);\r\nthis.returnsMap = this.mapKey != null;\r\nthis.rowBoundsIndex = this.getUniqueParamIndex(method, RowBounds.class);\r\nthis.resultHandlerIndex = this.getUniqueParamIndex(method, ResultHandler.class);\r\nthis.paramNameResolver = new ParamNameResolver(configuration, method);\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u8c03\u7528MapperMethod\u5bf9\u8c61\u7684",(0,t.jsx)(n.code,{children:"execute()"}),"\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// v3.5.14 & v3.5.4\r\nObject result;\r\nObject param;\r\nswitch(this.command.getType()) {\r\n    case INSERT:\r\n        param = this.method.convertArgsToSqlCommandParam(args);\r\n        result = this.rowCountResult(sqlSession.insert(this.command.getName(), param));\r\n        break;\r\n    case UPDATE:\r\n        param = this.method.convertArgsToSqlCommandParam(args);\r\n        result = this.rowCountResult(sqlSession.update(this.command.getName(), param));\r\n        break;\r\n    case DELETE:\r\n        param = this.method.convertArgsToSqlCommandParam(args);\r\n        result = this.rowCountResult(sqlSession.delete(this.command.getName(), param));\r\n        break;\r\n    case SELECT:\r\n        if (this.method.returnsVoid() && this.method.hasResultHandler()) {\r\n            this.executeWithResultHandler(sqlSession, args);\r\n            result = null;\r\n        } else if (this.method.returnsMany()) {\r\n            result = this.executeForMany(sqlSession, args);\r\n        } else if (this.method.returnsMap()) {\r\n            result = this.executeForMap(sqlSession, args);\r\n        } else if (this.method.returnsCursor()) {\r\n            result = this.executeForCursor(sqlSession, args);\r\n        } else {\r\n            param = this.method.convertArgsToSqlCommandParam(args);\r\n            // \u6267\u884c\u67e5\u8be2\r\n            result = sqlSession.selectOne(this.command.getName(), param);\r\n            if (this.method.returnsOptional() && (result == null || !this.method.getReturnType().equals(result.getClass()))) {\r\n                result = Optional.ofNullable(result);\r\n            }\r\n        }\r\n        break;\r\n    case FLUSH:\r\n        result = sqlSession.flushStatements();\r\n        break;\r\n    default:\r\n        throw new BindingException("Unknown execution method for: " + this.command.getName());\r\n}\r\n// ...\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"selectOne()"}),"\u8c03\u7528",(0,t.jsx)(n.code,{children:"selectList()"}),"\u53bb\u6570\u636e\u5e93\u67e5\u8be2\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// 3.5.14\r\nList var6;\r\ntry {\r\n    MappedStatement ms = this.configuration.getMappedStatement(statement);\r\n    // \u5224\u65ad\u662f\u5426\u662f\u810f\u8bfb\uff08\u6570\u636e\u5e93\u7684\u9694\u79bb\u7ea7\u522b\uff09\r\n    this.dirty |= ms.isDirtySelect();\r\n    var6 = this.executor.query(ms, this.wrapCollection(parameter), rowBounds, handler);\r\n} catch (Exception var10) {\r\n    throw ExceptionFactory.wrapException("Error querying database.  Cause: " + var10, var10);\r\n} finally {\r\n    ErrorContext.instance().reset();\r\n}\r\nreturn var6;\r\n\r\n// 3.5.4\r\ntry {\r\n    MappedStatement ms = configuration.getMappedStatement(statement);\r\n    return executor.query(ms, wrapCollection(parameter), rowBounds, Executor.NO_RESULT_HANDLER);\r\n} catch (Exception e) {\r\n    throw ExceptionFactory.wrapException("Error querying database, Cause: " + e, e);\r\n} finally {\r\n    ErrorContext.instance().reset();\r\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u8fdb\u5165",(0,t.jsx)(n.code,{children:"query()"}),"\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// 3.5.14 & 3.5.4\r\n// \u5355\u4f8b\u6a21\u5f0f\uff0c\u9488\u5bf9\u6bcf\u4e2a\u7ebf\u7a0b\u5355\u5f00\u4e00\u4e2a\u8bb0\u5f55\u9519\u8bef\u7684\u5bf9\u8c61\r\nErrorContext.instance().resource(ms.getResource()).activity("executing a query").object(ms.getId());\r\nif (this.closed) {\r\n    throw new ExecutorException("Executor was closed.");\r\n} else {\r\n    if (this.queryStack == 0 && ms.isFlushCacheRequired()) {\r\n        this.clearLocalCache();\r\n    }\r\n    List list;\r\n    try {\r\n        ++this.queryStack;\r\n        list = resultHandler == null ? (List)this.localCache.getObject(key) : null;\r\n        if (list != null) {\r\n            this.handleLocallyCachedOutputParameters(ms, key, parameter, boundSql);\r\n        } else {\r\n            // \u4ece\u6570\u636e\u5e93\u67e5\u8be2\r\n            list = this.queryFromDatabase(ms, parameter, rowBounds, resultHandler, key, boundSql);\r\n        }\r\n    } finally {\r\n        --this.queryStack;\r\n    }\r\n    // ...\r\n    return list;\r\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"queryFromDatabase()"}),"\u8fdb\u5165\u5230",(0,t.jsx)(n.code,{children:"doQuery()"}),"\uff1a\u5c01\u88c5JDBC","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// 3.5.14 & 3.5.4\r\n// doQuery()\r\nStatement stmt = null;\r\nList var9;\r\ntry {\r\n    Configuration configuration = ms.getConfiguration();\r\n    StatementHandler handler = configuration.newStatementHandler(this.wrapper, ms, parameter, rowBounds, resultHandler, boundSql);\r\n    // \u9884\u7f16\u8bd1SQL\u8bed\u53e5\r\n    stmt = this.prepareStatement(handler, ms.getStatementLog());\r\n    // \u6267\u884c\u67e5\u8be2\r\n    var9 = handler.query(stmt, resultHandler);\r\n} finally {\r\n    this.closeStatement(stmt);\r\n}\r\nreturn var9;\r\n\r\n// this.prepareStatement()\r\n// \u83b7\u53d6\u4e0e\u6570\u636e\u5e93\u7684\u8fde\u63a5\r\nConnection connection = this.getConnection(statementLog);\r\n// \u9884\u7f16\u8bd1SQL\u8bed\u53e5\r\nStatement stmt = handler.prepare(connection, this.transaction.getTimeout());\r\nhandler.parameterize(stmt);\r\nreturn stmt;\r\n\r\n// handler.query()\r\nPreparedStatement ps = (PreparedStatement)statement;\r\n// \u6267\u884c\u9884\u7f16\u8bd1SQL\u8bed\u53e5\r\nps.execute();\r\nreturn this.resultSetHandler.handleResultSets(ps);\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:["\u83b7\u53d6\u8fde\u63a5",(0,t.jsx)(n.code,{children:"getConnection()"}),"\u5230",(0,t.jsx)(n.code,{children:"openConnection()"}),"\uff1a\u52a8\u6001\u4ee3\u7406\u8fde\u63a5","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// 3.5.14 & 3.5.4\r\nreturn this.popConnection(this.dataSource.getUsername(), this.dataSource.getPassword()).getProxyConnection();\r\n\r\n// this.popConnection()\r\nboolean countedWait = false;\r\nPooledConnection conn = null;\r\nlong t = System.currentTimeMillis();\r\nint localBadConnectionCount = 0;\r\nwhile(conn == null) {\r\n    // \u52a0\u9501\uff0c\u786e\u4fdd\u591a\u7ebf\u7a0b\u7684\u60c5\u51b5\u4e0b\u8fde\u63a5\u7684\u5b89\u5168\u6027\r\n    this.lock.lock();\r\n    try {\r\n        PoolState var10000;\r\n        if (!this.state.idleConnections.isEmpty()) {\r\n            conn = (PooledConnection)this.state.idleConnections.remove(0);\r\n            if (log.isDebugEnabled()) {\r\n                log.debug("Checked out connection " + conn.getRealHashCode() + " from pool.");\r\n            }\r\n        } else if (this.state.activeConnections.size() < this.poolMaximumActiveConnections) {\r\n            // \u83b7\u53d6\u8fde\u63a5\uff0c\u5c01\u88c5\u6210\u52a8\u6001\u4ee3\u7406\u5bf9\u8c61PooledConnection\r\n            conn = new PooledConnection(this.dataSource.getConnection(), this);\r\n            if (log.isDebugEnabled()) {\r\n                log.debug("Created connection " + conn.getRealHashCode() + ".");\r\n            }\r\n        } // ...\r\n    } finally {\r\n        this.lock.unlock();\r\n    }\r\n    // ...\r\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"dataSource.getConnection()"}),"\u8fdb\u5165\u5230",(0,t.jsx)(n.code,{children:"doGetConnection()"}),"\uff1a\u771f\u6b63\u83b7\u53d6\u8fde\u63a5\u7684\u65b9\u6cd5","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:'// 3.5.14 & 3.5.4\r\nProperties props = new Properties();\r\nif (this.driverProperties != null) {\r\n    props.putAll(this.driverProperties);\r\n}\r\nif (username != null) {\r\n    props.setProperty("user", username);\r\n}\r\nif (password != null) {\r\n    props.setProperty("password", password);\r\n}\r\nreturn this.doGetConnection(props);\r\n\r\n// this.doGetConnection()\r\n// \u521d\u59cb\u5316\u9a71\u52a8\r\nthis.initializeDriver();\r\n// \u4ece\u9a71\u52a8\u7ba1\u7406\u5668\u4e2d\u83b7\u53d6\u8fde\u63a5\r\nConnection connection = DriverManager.getConnection(this.url, properties);\r\nthis.configureConnection(connection);\r\nreturn connection;\r\n\r\n// this.initializeDriver()\r\nif (!registeredDrivers.containsKey(this.driver)) {\r\n    try {\r\n        Class driverType;\r\n        if (this.driverClassLoader != null) {\r\n            // \u83b7\u53d6\u9a71\u52a8\u7c7b\r\n            driverType = Class.forName(this.driver, true, this.driverClassLoader);\r\n        } else {\r\n            driverType = Resources.classForName(this.driver);\r\n        }\r\n\r\n        Driver driverInstance = (Driver)driverType.getDeclaredConstructor().newInstance();\r\n        // \u6ce8\u518c\u9a71\u52a8\r\n        DriverManager.registerDriver(new UnpooledDataSource.DriverProxy(driverInstance));\r\n        registeredDrivers.put(this.driver, driverInstance);\r\n    } catch (Exception var3) {\r\n        throw new SQLException("Error setting driver on UnpooledDataSource. Cause: " + var3);\r\n    }\r\n}\n'})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"queryFromDatabase()"}),"\u8fdb\u5165\u5230",(0,t.jsx)(n.code,{children:"doQuery()"}),"\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// 3.5.14 & 3.5.4\n"})}),"\n"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.code,{children:"queryFromDatabase()"}),"\u8fdb\u5165\u5230",(0,t.jsx)(n.code,{children:"doQuery()"}),"\uff1a","\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"// 3.5.14 & 3.5.4\n"})}),"\n"]}),"\n"]}),"\n",(0,t.jsx)(n.p,{children:"22!!!"})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>o,x:()=>i});var t=r(6540);const s={},a=t.createContext(s);function o(e){const n=t.useContext(a);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function i(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);